# LLMShield Malware Detection Architecture

## Overview
LLMShield uses a multi-layered approach to detect malware in ML models, combining signature-based detection, behavioral analysis, and deep model inspection.

## Detection Layers

### 1. Signature-Based Detection (EnhancedSignatureScanner)

**Database Location**: `/config/malware_signatures.yaml`

#### Features:
- **Binary Signatures**: Detects embedded executables (ELF, PE, Mach-O)
- **Hash Database**: SHA256 hashes of known malicious models
- **Shellcode Patterns**: x86/x64 shellcode detection
- **Malware Families**: Slackor, ModelStealer, CryptoJacker
- **C2 Indicators**: Domains, IPs, ports used by malware
- **Pickle Malware**: Reverse shells, file stealers, ransomware

#### How It Works:
```python
# Example: Detecting embedded executable
if file_content.startswith(b'\x7fELF'):  # Linux ELF
    report_malware("Embedded Linux executable")
    
# Example: Hash matching
file_hash = sha256(file_content)
if file_hash in malware_database:
    report_malware("Known malicious model")
```

### 2. Behavioral Analysis (BehavioralScanner)

#### Features:
- **Safe Loading**: Monitors what happens during model load
- **Import Tracking**: Detects suspicious imports (socket, subprocess)
- **System Calls**: Identifies OS interaction attempts
- **Network Activity**: Detects communication attempts

#### How It Works:
```python
# Restricted unpickler tracks dangerous operations
class SafeUnpickler(pickle.Unpickler):
    def find_class(self, module, name):
        if module in ['os', 'subprocess', 'socket']:
            report_violation("Dangerous module import")
```

### 3. Model Integrity Analysis (ModelIntegrityScanner)

#### Features:
- **Binary Structure**: Analyzes raw file for malware
- **Layer Inspection**: Checks each layer for code execution
- **Statistical Analysis**: Detects backdoors via weight anomalies
- **Metadata Scanning**: Finds hidden code in metadata

#### How It Works:
```python
# Example: Statistical anomaly detection
if layer_variance < 0.0001:  # Near-zero variance
    report_anomaly("Possible backdoor trigger")
    
# Example: Layer inspection
if hasattr(layer, '__reduce__'):
    report_threat("Layer can execute arbitrary code")
```

## Detection Flow

```
1. File Input
   ↓
2. File Parsing → Extract model structure
   ↓
3. Signature Scan → Check against malware DB
   ↓
4. Behavioral Analysis → Monitor loading behavior
   ↓
5. Integrity Check → Deep model inspection
   ↓
6. Report Generation → Consolidate findings
```

## Malware Types Detected

### 1. **Embedded Executables**
- Linux ELF binaries
- Windows PE files
- macOS Mach-O files
- Shellcode payloads

### 2. **Code Execution Vectors**
- Pickle exploits (__reduce__, __setstate__)
- Eval/exec patterns
- Dynamic imports
- Subprocess calls

### 3. **ML-Specific Attacks**
- Model backdoors (statistical detection)
- Data poisoning (weight anomalies)
- Model stealing (exfiltration code)
- Adversarial triggers

### 4. **C2 Communication**
- Known C2 domains
- Suspicious ports
- Network protocols
- Data exfiltration

### 5. **Cryptominers**
- Mining pool addresses
- Stratum protocols
- GPU hijacking code

## Database Updates

### Current Database Stats:
- **Binary Signatures**: 6 types
- **Known Hashes**: 3 malicious models
- **Malware Families**: 3 families
- **C2 Indicators**: 15+ domains/ports
- **Pickle Patterns**: 3 types

### Adding New Signatures:
1. Edit `/config/malware_signatures.yaml`
2. Add to appropriate section:
   ```yaml
   malicious_hashes:
     new_malware:
       hash: "abc123..."
       name: "New Malware"
       severity: "CRITICAL"
   ```

## File Path Reporting

All scanners report the specific file containing vulnerabilities:
- Text reports show: `File: model.pkl`
- HTML reports show file name in each vulnerability card
- JSON reports include `file_path` field

## Usage

The advanced detection runs automatically:
```bash
# Single file scan
llmshield scan model.pkl

# Directory scan
llmshield scan /models/ --recursive

# Results show file paths:
# "File: models/backdoor.pkl - Critical: Embedded executable"
```

## Future Enhancements

1. **Real-time Signature Updates**
   - Connect to threat intelligence feeds
   - Auto-update malware signatures

2. **Sandbox Execution**
   - Full isolated environment
   - System call monitoring
   - Network traffic analysis

3. **ML-Based Detection**
   - Train on malware/benign models
   - Detect unknown threats
   - Behavioral clustering

4. **YARA Integration**
   - Import YARA rules
   - Custom rule creation
   - Community rule sharing